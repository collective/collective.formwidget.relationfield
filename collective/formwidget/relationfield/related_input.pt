<i18n:domain i18n:domain="collective.formwidget.relationfield">
    <div tal:attributes="id string:${view/id}-autocomplete">
        <div tal:attributes="id string:${view/id}-input-fields" class="autocompleteInputWidget"
            tal:content="structure view/renderQueryWidget" />
        <tal:block replace="structure view/subform/render" />
    </div>
    <div class="contenttreeWindow"
        tal:attributes="id string:${view/id}-contenttree-window">
        <div class="contenttreeWindowHeader">
            <h2 i18n:translate="heading_contenttree_browse">Browse for items</h2>
            <em tal:condition="view/multi_select"
                i18n:translate="heading_contenttree_help">Press Ctrl to select multiple items....
            </em>
        </div>
        <div class="contenttreeDroppable"><ul id="content-droppable"><span class="ui-widget-header">Droppable</span></ul></div>
        <div class="contenttreeWidget"
            tal:attributes="id string:${view/id}-contenttree">
            <ul class="navTree navTreeLevel0">
                <li tal:replace="structure python:view.render_tree(relPath=None,query=None,limit=10)" />
            </ul>
        </div>
        <div class="contenttreeWindowActions">
            <input class="context contentTreeAdd" type="button" i18n:attributes="value label_contenttree_add" value="Add"/> <input class="standalone contentTreeCancel" i18n:attributes="value label_contenttree_cancel" type="button" value="Cancel"/>
        </div>
    </div>
    <script type="text/javascript" tal:content="structure view/js"></script>
    <script type="text/javascript">
        //<![CDATA[
    jq(function() {
            //jq('li.draggable').draggable({containment: ".contenttreeDroppable", snap: true, revert: true});
            jq('.contenttreeWidget .navTree, #content-droppable').sortable({revert: true});
            jq('#content-droppable').droppable({
                    //accept: "div.draggable",
                    accept: ".navTree li.draggable",
                    activeClass: "ui-state-hover",
                    hoverClass: "ui-state-active",
                    drop: function(event, ui) {
                        //jq(this).addClass("ui-state-highlight");
                        var $dragged = ui.draggable;
                        copyToDroppable( $dragged );
                        }
                    });
            function copyToDroppable( $item ) {
                var $droppable = jq('#content-droppable');
                var link = $item.find("a").attr("href")
                var txt = "";
                txt += link;
                jq($item).addClass("ui-state-disabled");
                jq($item).removeClass("draggable");
                var $newli = jq("<li class='draggable ui-widget-content width-full' />");
                var $newh3 = jq("<h3 class='ui-widget-header' />");
                var $newp = jq("<p class='ui-widget-content' />");
                var $del = jq("<a class='ui-icon ui-icon-trash' href='' />");
                $newli.attr('id', 'copied-'+$item.attr('id'));
                $newh3.text($item.find('h3').text());
                $newh3.appendTo($newli);
                $newp.text(txt);
                $newp.appendTo($newli);
                $del.appendTo($newli);
                $newli.appendTo($droppable);
            }
            function removeFromDroppable( $item ) {
                var $dropping = jq('#content-droppable');
                var $listing = jq('.contenttreeWidget .navTree');
                var $item_id = $item.attr('id');
                var $listing_id = $item_id.match(/^copied-(.+)$/)[1];
                jq('#'+$listing_id).removeClass("ui-state-disabled");
                jq('#'+$listing_id).addClass("draggable");
                $item.remove();
            }
            var $listing = jq('#sortable-container');
            jq('.contenttreeWidget .navTree li').draggable({
                    //containment: "#sortable-container",
                    //connectToSortable: "#content-droppable",
                    helper: "clone",
                    revert: "invalid"
                    });
            jq('ul#content-droppable').click(function(event) {
                    var $item = jq(this);
                    var $target = jq(event.target);
                    var $parent = jq($target).parent();

                    if ( $target.is("a.ui-icon-trash") ) {
                        removeFromDroppable($parent);
                        }
                    return false
                    });
            });
//]]>
</script>
<style type="text/css">
    <!--
    ul#content-droppable { list-style-type: none;}
    .contenttreeDroppable { display: block; margin: 0 1em; overflow-y: auto; position: absolute; left: 0; top: 5em; bottom: 3.5em; }
    .contenttreeDroppable, .contenttreeWidget { width: 48%; float: left; left: auto; }
    .contenttreeWidget { left: initial; top: 5em; }
    #content-droppable, #sortable-container { background: #f0fff0; text-align: center;}
    #content-droppable { min-height: 150px; }
    #content-droppable li, #content-droppable span { display: block; }
    /*
    .ui-icon-trash { float: right; }
    */
    -->
</style>
</i18n:domain>
